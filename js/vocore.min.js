$(function() {
  var i, j, k, count = 0;
  var country, cost1, cost2;

  $.getJSON("cgi-bin/geoip", function(json) {
      country = json.country; cost1 = json.cost1; cost2 = json.cost2;
  });

  // ui logic.
  function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    if(r !== null)
      return unescape(r[2]);
    return "";
  }

  if(getQueryString("status") === "success")
    $("#mdSuccess").modal("show");

  $("[data-toggle='tooltip']").tooltip();

  function warning(id, cap, note, timeout) {
    var d = "";
    if(cap === "")
        cap = "btnAlertClose";
    d += '<div class="alert alert-warning alert-dismissible fade in out" role="alert">';
    d += '<button id="' + cap + '" type="button" class="close" data-dismiss="alert" aria-label="Close">';
    d += '<span aria-hidden="true">&times;</span></button>' + note + '</div>';
    $(id).before(d);
    if(typeof(timeout) == "undefined" || timeout > 0)
        setTimeout(function() { $("#btnAlertClose").click(); }, typeof(timeout) != "undefined" ? timeout : 3000);
  }

  var arr = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25];
  for(i = 1; ; i++) {
    var list = "<tbody>";
    if($("#tbCount" + i).length <= 0)
        break;
    for(j = 0; j < 5; j++) {
      list += "<tr>";
      for(k = 0; k < 5; k++)
        list += "<td><a>" + arr[j * 5 + k] + "</a></td>";
      list += "</tr>";
    }
    count++;
    $("#tbCount" + i).html(list + "</tbody>");
  }

  $("#tbStore").on("click", "td", function() {
    var table = $(this).parent().parent().parent().attr("id");
    if(table.substr(0, table.length - 1) === "tbCount")
      $("#dbCount" + table.substr(table.length - 1, 1)).find("b").html($(this).find("a").html());
  });

  $("#mdCheckOut").on("show.bs.modal", function(event) {
    var units = 0;
    for(i = 1; i <= count; i++)
      units += parseInt($("#dbCount" + i).find("b").html());
    if(units == 0) {
      warning("#btnCheckOut", "", "Please choose at least one item.");
      return false;
    }
    $("#edCountry").html(country + '<span class="caret"></span>');
    update();
    return true;
  });
  $("#rbShipping1").on("click", function() {
      update();
  });
  $("#rbShipping2").on("click", function() {
      update();
  });

  // calculate logic.
  function chophead(s, i) { s = s.substr(i, s.length - i); return s; }
  function update() {
      var order = "", cart = "", total = 0, custom = "post", ship = 0;
      for(i = 1; i <= count; i++) {
          var unit_name = $("#lbItem" + i).html();
          var unit_price = chophead($("#btnPrice" + i).find("b").html(), 1);
          var unit_count = $("#dbCount" + i).find("b").html();
          var unit_total = parseFloat(unit_price) * parseInt(unit_count);
          if(unit_count === "0")
              continue;
          cart += "<tr><th>" + unit_name + "</th>";
          cart += "<td>$" + unit_price + "</td>";
          cart += "<td>" + unit_count + "</td>";
          cart += "<td>$" + unit_total.toFixed(2) + "</td></tr>";
          order += '<input type="hidden" name="item_name_' + i + '" value="' + unit_name + '">';
          order += '<input type="hidden" name="amount_' + i + '" value="' + unit_price + '">';
          order += '<input type="hidden" name="quantity_' + i + '" value="' + unit_count + '">';
          total += unit_total;
      }

      custom = $("#rbShipping1").prop("checked") ? "post" : "express";
      ship = parseFloat($("#rbShipping1").prop("checked") ? cost1 : cost2) + total * 0.05;
      cart += "<tr><th>Shipping to " + country + "</th>";
      cart += "<td>$" + ship.toFixed(2) + "</td><td>1</td>";
      cart += "<td>$" + ship.toFixed(2) + "</td></tr>";
      total += parseFloat(ship);

      $("#fmPaypal").children("input").remove();
      order += '<input type="hidden" name="cmd" value="_cart">';
      order += '<input type="hidden" name="upload" value="1">';
      order += '<input type="hidden" name="business" value="sales@vocore.io">';
      order += '<input type="hidden" name="shipping_1" value="' + ship.toFixed(2) + '">';
      order += '<input type="hidden" name="custom" value="' + custom + '">';
      order += '<input type="hidden" name="notify_url" value="http://vocore.io/cgi-bin/notify">';

      $("#lbTotal").find("b").html(total.toFixed(2));
      $("#tbCartList").find("tbody").html(cart);
      $("#btnContinue").before(order);
  }

});
