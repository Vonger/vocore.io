$(function() {
  var s_count = 3;   // item number in store.
  var s_clist = "";  // express country, price1, carrier1, price2, carrier2.
  var s_ppva1, s_ppva2;
  var s_store;

  // paypal return success ordered, we show a box.
  if(getQueryString("status") == "success")
    $("#mdSuccess").modal("show");

  // enable tooltip in modal dialog.
  $("[data-toggle='tooltip']").tooltip();

  // create table list by code.
  for(var i = 1; i <= s_count; i++) {
    var array = new Array(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 15, 20, 25, 30, 40, 50, 60, 70, 80, 90, 100, 120, 150, 200);
    var list = "<tbody>";
    for(var j = 0; j < 5; j++) { // five items in a row.
      list += "<tr>";
      for(var k = 0; k < 5; k++)
        list += "<td><a>" + array[j * 5 + k] + "</a></td>";
      list += "</tr>";
    }
    $("#tbCount" + i).html(list + "</tbody>");
  }

  // decode json data file and the current country/express price list.
  $.getJSON("data/express.json", function(json) {
    s_clist = json.express;
    s_count = json.store.length;
    s_ppva1 = parseFloat(json.paypal[0]);
    s_ppva2 = parseFloat(json.paypal[1]);
    s_store = json.store;

    // put json.store data to update list.
    for(var i = 1; i <= s_count; i++) {
      $("#lbItem" + i).html(s_store[i - 1][0]);
      $("#lbPrice" + i).html("$" + s_store[i - 1][2]);
      $("#lbImg" + i).prop("src", s_store[i - 1][3]);
      $("#lbItemDet" + i).html(s_store[i - 1][4]);
    }

    var list = "";
    for(var i = 0; i < s_clist.length; i++)
      list += "<li><a class='country-item'>" + s_clist[i][0] + "</a></li>";
    $("#lstCountry").html(list);
  });

  // insert alert of warning before id.
  function warning(id, cap, note, timeout) {
    var d = "";
    d += '<div class="alert alert-warning alert-dismissible fade in out" role="alert">';
    d += '<button id="btnAlertClose" type="button" class="close" data-dismiss="alert" aria-label="Close">';
    d += '<span aria-hidden="true">&times;</span></button>';
    d += '<strong>' + cap + '  </strong>' + note + '</div>';
    $(id).before(d);
    // auto close the alert after 3 seconds.
    setTimeout(function() { $("#btnAlertClose").click(); }, typeof(timeout) != "undefined" ? timeout : 3000);
  }

  // get the value from html code.
  function getParameter(type, index) {
    if(type == "count")
      return $("#dbCountList" + index).find("b").html();
    if(type == "name")
      return $("#lbItem" + index).html();
    if(type == "price")
      return $("#btnPrice" + index).find("b").html();
  }

  function getExpressPrice(country) {
    // search for the express price in the list.
    for(var i = 0; i < s_clist.length; i++) {
      if(s_clist[i][0] != country)
        continue;

      var type = $("#cbRemote").prop("checked") ? 3 : 1;
      return parseFloat(s_clist[i][type]).toFixed(2);
    }
    // internal error: the country is not in the list.
    return -1;
  }

  function getExpressName(country) {
    // search for the express name in the list.
    for(var i = 0; i < s_clist.length; i++) {
      if(s_clist[i][0] != country)
        continue;

      var type = $("#cbRemote").prop("checked") ? 4 : 2;
      return s_clist[i][type];
    }
    // internal error: the country is not in the list.
    return "";
  }

  function getQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
    var r = window.location.search.substr(1).match(reg);
    if(r != null)
      return unescape(r[2]);
    return "";
  }

  // calculate the cart list value.
  function updateCartList() {
    var cart = "", order = "", total = 0.0;
    var host = "www.baizaoshan.com";

    // clear up last order items in form.
    $("#fmPaypal").children("input").remove();

    // basic items.
    for(var i = 1, j = 1; i <= s_count; i++) {
      var price = getParameter("price", i);
      var count = getParameter("count", i);
      var name = getParameter("name", i);
      var sum = parseFloat(price.substr(1, price.length - 1)) * parseInt(count);
      if(count != 0) {
        var pend = i * 10 + parseInt(count);
        cart += "<tr><th>" + name + "</th><td>" + price + "</td><td>" + count + "</td><td>$" + sum.toFixed(2) + "</td></tr>";
        order += '<input type="hidden" name="item_name_' + j + '" value="' + name + '">';
        order += '<input type="hidden" name="amount_' + j + '" value="' + price + '">';
        order += '<input type="hidden" name="quantity_' + j + '" value="' + count + '">';
        total += sum; j++;
      }
    }

    // express shipping
    var shipping = 0.0;
    if($("#rbShipping2").prop("checked")) {
      var country = $.trim($("#edCountry").text());
      var price = getExpressPrice(country);
      var express = getExpressName(country);
      var name = express + " to " + country;
      if(price > 0) {
        shipping = parseFloat(price);
        cart += "<tr id='trExpress'><th>" + name + "</th><td>$" + price + "</td><td>" + "1" + "</td><td>$" + price + "</td></tr>";
        total += shipping;
      }
      $("#divExpress").removeClass("hide");
    } else {
      $("#divExpress").addClass("hide");
      $("#trExpress").remove();
    }

    // paypal cost
    var paypal = (total * s_ppva1 + s_ppva2) / (1.0 - s_ppva1);
    cart += "<tr><th>" + "PayPal Fee" + "</th><td>$" + paypal.toFixed(2) + "</td><td>" + "1" + "</td><td>$" + paypal.toFixed(2) + "</td></tr>";
    order += '<input type="hidden" name="shipping_1" value="' + (paypal + shipping).toFixed(2) + '">';
    total += paypal;

    $("#tbCartList").find("tbody").html(cart);
    $("#lbTotal").find("b").html(total.toFixed(2));

    $("#btnContinue").before('<input type="hidden" name="cmd" value="_cart">');
    $("#btnContinue").before('<input type="hidden" name="upload" value="1">');
    $("#btnContinue").before('<input type="hidden" name="business" value="sales@vocore.io">');
    $("#btnContinue").before('<input type="hidden" name="notify_url" value="http://' + host + '/cgi-bin/notify">');
    $("#btnContinue").before('<input type="hidden" name="return_url" value="http://' + host + '/?status=success">');
    $("#btnContinue").before(order);
  }

  // update store item count dropdown table value.
  $("#tbStore").on("click", "td", function() {
    var table = $(this).parent().parent().parent().attr("id");
    if(table.substr(0, table.length - 1) == "tbCount") {
      var id = table.substr(table.length - 1, 1)
      var count = $(this).find("a").html();
      // update the count with selected number.
      $("#dbCountList" + id).find("b").html(count);
    }
  });

  // update country item list value.
  $("#lstCountry").on("click", "a", function(event) {
    $("#edCountry").html($.trim($(this).html()) + '\n<span class="caret"></span>');
    updateCartList();
  });

  $("#mdCheckOut").on("show.bs.modal", function(event) {
    var total = 0;
    // check parameters.
    for(var i = 1; i <= s_count; i++)
      total += parseInt(getParameter("count", i));
    if(total == 0) {
      warning("#btnCheckOut", "", "Please choose at least one item so we can move forward.");
      // prevent display the box.
      return false;
    }
    updateCartList();
    return true;
  });

  $("#cbRemote").on("click", function() {
    updateCartList();
  });
  $("#rbShipping1").on("click", function() {
    updateCartList();
  });
  $("#rbShipping2").on("click", function() {
    updateCartList();
  });

  $("#btnContinue").on("click", function() {
    var phone = $.trim($("#edPhone").val());
    if(phone.length < 5 || phone.length > 20) {
      warning("#tbPhone", "", "Please input a valid phone number.");
      return false;
    }

    if($("#rbShipping2").prop("checked")) {
      var country = $.trim($("#edCountry").text()), find = false;
      for(var i = 0; i < s_clist.length; i++) {
        if(country != s_clist[i][0])
          continue;
        find = true;
        break;
      }
      if(!find) {
        warning("#divExpress", "", "Please select the country you ship to.");
        return false;
      }
    }

    $("#btnContinue").before('<input type="hidden" name="custom" value="' + phone + '">');
    return true;
  });
});
