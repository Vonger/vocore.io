$(function() {
    var i, j, k, count = 0;
    var country = "Select Country", cost1, cost2, countries_name = "", countries_code = "";

    $.getJSON("http://vocore.io/cgi-bin/geoip", function(json) {
        country = json.country; cost1 = json.cost1; cost2 = json.cost2;
    });

    // ui logic.
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if(r !== null)
            return unescape(r[2]);
        return "";
    }

    if(getQueryString("status") === "success")
        $("#mdSuccess").modal("show");

    $("[data-toggle='tooltip']").tooltip();
    $("#lbExpressNotify").hide();

    function warning(id, cap, note, timeout) {
        var d = "";
        if(cap === "")
            cap = "btnAlertClose";
        d += '<div class="alert alert-warning alert-dismissible fade in out" role="alert">';
        d += '<button id="' + cap + '" type="button" class="close" data-dismiss="alert" aria-label="Close">';
        d += '<span aria-hidden="true">&times;</span></button>' + note + '</div>';
        $(id).before(d);
        if(typeof(timeout) == "undefined" || timeout > 0)
            setTimeout(function() { $("#btnAlertClose").click(); }, typeof(timeout) != "undefined" ? timeout : 3000);
    }

    var arr = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25];
    for(i = 1; ; i++) {
        var list = "<tbody>";
        if($("#tbCount" + i).length <= 0)
            break;
        for(j = 0; j < 5; j++) {
            list += "<tr>";
            for(k = 0; k < 5; k++)
                list += "<td><a>" + arr[j * 5 + k] + "</a></td>";
            list += "</tr>";
        }
        count++;
        $("#tbCount" + i).html(list + "</tbody>");
    }

    $("#tbStore").on("click", "td", function() {
        var table = $(this).parent().parent().parent().attr("id");
        if(table.substr(0, table.length - 1) === "tbCount")
            $("#dbCount" + table.substr(table.length - 1, 1)).find("b").html($(this).find("a").html());
    });

    $("#mdCheckOut").on("show.bs.modal", function(event) {
        var units = 0;
        for(i = 1; i <= count; i++)
            units += parseInt($("#dbCount" + i).find("b").html());
        if(units === 0) {
            warning("#btnCheckOut", "", "Please choose at least one item.");
            return false;
        }
        $("#edCountry").html(country + '<span class="caret"></span>');

        update();
        return true;
    });
    $("#rbShipping1").on("click", function() {
        update();
    });
    $("#rbShipping2").on("click", function() {
        update();
    });
    $("#btnTrace").on("click", function() {
        trace(0);
    });
    $('#edTrace').bind("keypress", function(event) {
        if(event.keyCode === 13)
            trace(0);
    });
    $("#edCountry").on("click", function() {
        if(countries_name.length <= 0 || countries_code.length <= 0) {
            // insert a spin indicator
            $.getJSON("js/countries.json", function(json) {
                countries_name = json.name;
                countries_code = json.code;
                var countries_list = "";
                for(i = 0; i < countries_name.length; i++)
                    countries_list += "<li><a>" + countries_name[i] + "</a></li>";
                $("#lstCountry").html(countries_list);
            });
        }
    });
    $("#lstCountry").on("click", "li", function() {
        for(i = 0; i < countries_name.length; i++) {
            if(countries_name[i] === $(this).find("a").html())
                break;
        }
        $("#edCountry").html(countries_name[i] + '<span class="caret"></span>');

        $.getJSON("http://vocore.io/cgi-bin/geoip?code=" + countries_code[i], function(json) {
            country = json.country; cost1 = json.cost1; cost2 = json.cost2;
            update();
        });
    });

    // calculate logic.
    function chophead(s, i) { s = s.substr(i, s.length - i); return s; }
    function update() {
        var order = "", cart = "", total = 0, ship = 0, id;
        if (cost1 === cost2) {
            $("#rbShipping1").prop("checked", true);
            $("#rbShipping2").attr("disabled", "disabled");
        } else {
            $("#rbShipping2").removeAttr("disabled");
        }
        for(i = 1, id = 1; i <= count; i++) {
            var unit_name = $("#lbItem" + i).html();
            var unit_price = chophead($("#btnPrice" + i).find("b").html(), 1);
            var unit_count = $("#dbCount" + i).find("b").html();
            var unit_total = parseFloat(unit_price) * parseInt(unit_count);
            if(unit_count === "0")
                continue;
            cart += "<tr><th>" + unit_name + "</th>";
            cart += "<td>$" + unit_price + "</td>";
            cart += "<td>" + unit_count + "</td>";
            cart += "<td>$" + unit_total.toFixed(2) + "</td></tr>";
            order += '<input type="hidden" name="item_name_' + id + '" value="' + unit_name + '">';
            order += '<input type="hidden" name="amount_' + id + '" value="' + unit_price + '">';
            order += '<input type="hidden" name="quantity_' + id + '" value="' + unit_count + '">';
            total += unit_total; id++;
        }
        if ($("#rbShipping1").prop("checked")) {
            carrier = "post";
            // free shipping for now, ignore cost1.
            ship = 0;   // parseFloat(cost1);
            $("#lbExpressNotify").hide();
        } else {
            carrier = "express";
            ship = parseFloat(cost2);

            cart += "<tr><th>Shipping to " + country + "</th>";
            cart += "<td>$" + ship.toFixed(2) + "</td><td>1</td>";
            cart += "<td>$" + ship.toFixed(2) + "</td></tr>";
            total += parseFloat(ship);
            $("#lbExpressNotify").show();
        }
        $("#fmPaypal").children("input").remove();
        order += '<input type="hidden" name="cmd" value="_cart">';
        order += '<input type="hidden" name="upload" value="1">';
        order += '<input type="hidden" name="business" value="sales@vocore.io">';
        order += '<input type="hidden" name="shipping_1" value="' + ship.toFixed(2) + '">';
        order += '<input type="hidden" name="custom" value="' + carrier + '">';
        order += '<input type="hidden" name="notify_url" value="http://vocore.io/cgi-bin/notify">';
        $("#lbTotal").find("b").html(total.toFixed(2));
        $("#tbCartList").find("tbody").html(cart);
        $("#btnContinue").before(order);
    }
    function trace(id) {
        if (id === 0)
            $("#lbTraceInfo").html("<h5>Searching... Please wait a few seconds.</h5>");

        email =  $("#edTrace").val();
        $.getJSON("http://vocore.io/cgi-bin/trace?email=" + encodeURIComponent(email) + "&index=" + id, function(json) {
            if (id === 0)
                $("#lbTraceInfo").html("");
            if (json.status === "empty") {
                if (id === 0)
                    $("#lbTraceInfo").html("<h5>Sorry, no record yet, please check later.</h5>");
                $("#lbTraceInfo").html($("#lbTraceInfo").html() + "<p><b><small>Data is refreshed every hour</small></b></p>");
                return;
            }

            cur = $("#lbTraceInfo").html();
            if (json.status === "completed" || json.status === "shipped") {
                if (json.trace.substr(json.trace.length - 2) === "CN") {
                  if (json.trace.substr(0, 2) === "LT") {
                    json.carrier = "China EMS";
                  } else {
                    json.carrier = "China Post";
                  }
                }
                if (json.carrier === "DHL(ASIA) eCommence" || json.carrier === "Deutsche Post") {
                  info = "https://dhlecommerce.asia/Portal/Track?ref=" + json.trace;
                } else if (json.carrier === "DHL Express") {
                  info = "http://www.dhl.com/en/express/tracking.html?AWB=" + json.trace;
                } else if (json.trace.substr(0, 2) === "RR" && json.trace.substr(json.trace.length - 2) === "VU") {
                  info = "http://track.bpostchina.com/Tracking/Results?barcode=" + json.trace;
                } else {
                  info = "http://www.17track.net/en/track?nums=" + json.trace;
                }
                cur += "<h5>Your package has shipped by " + json.carrier + " to " + json.city + ", ";
                cur += json.country + ".</h5><h5><small>Package: " + json.cart.substr(0, json.cart.length - 2) + ". ";
                cur += "Trace ID: <b><a target='_blank' style='color:#F80;' href='" + info + "\'>" + json.trace + "</a></b></small></h5>";
            } else {
                cur += "<h5>We are preparing your package, it will ship to " + json.city + ", ";
                cur += json.country + ".</h5><h5><small>Package: " + json.cart.substr(0, json.cart.length - 2) + ".</small></h5>";
            }
            $("#lbTraceInfo").html(cur);
            trace(id + 1);
        });
    }
});
